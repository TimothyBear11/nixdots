#!/usr/bin/env bash
# shell-switch - Simple shell switcher for Hyprland
# Supports: Ambxst, Caelestia, DMS, Noctalia

set -eo pipefail

# Shell data - parallel arrays
shells=("ambxst" "caelestia" "dms" "noctalia")
names=("Ambxst" "Caelestia" "DMS" "Noctalia")
launch_cmds=("ambxst" "caelestia-shell -d" "dms run" "noctalia-shell")
quit_cmds=("pkill -f quickshell.*ambxst" "pkill -f quickshell.*caelestia" "pkill -f quickshell.*dms" "pkill -f quickshell.*noctalia")
patterns=("quickshell.*ambxst" "quickshell.*caelestia" "quickshell.*dms" "quickshell.*noctalia")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Get shell index by name
get_shell_index() {
    local name="$1"
    for i in "${!shells[@]}"; do
        if [[ "${shells[$i]}" == "$name" ]]; then
            echo "$i"
            return 0
        fi
    done
    echo "-1"
}

# Detect currently running shell
detect_shell() {
    for i in "${!shells[@]}"; do
        if pgrep -f "${patterns[$i]}" &>/dev/null; then
            echo "${shells[$i]}"
            return 0
        fi
    done
    echo ""
}

# Kill a shell
kill_shell() {
    local idx="$1"
    local shell="${shells[$idx]}"
    
    if ! pgrep -f "${patterns[$idx]}" &>/dev/null; then
        log "$shell is not running"
        return 0
    fi
    
    log "Stopping $shell..."
    
    # Try graceful quit
    eval "${quit_cmds[$idx]}" &>/dev/null || true
    sleep 0.5
    
    # Force if still running
    if pgrep -f "${patterns[$idx]}" &>/dev/null; then
        pkill -f "${patterns[$idx]}" || true
        sleep 0.5
    fi
    
    if pgrep -f "${patterns[$idx]}" &>/dev/null; then
        pkill -9 -f "${patterns[$idx]}" || true
    fi
    
    log "Stopped $shell"
}

# Start a shell
start_shell() {
    local idx="$1"
    local shell="${shells[$idx]}"
    log "Starting $shell..."
    ${launch_cmds[$idx]} &>/dev/null &
    sleep 1
    log "Started $shell"
}

# Update Hyprland config
update_config() {
    local idx="$1"
    local conf="$HOME/.config/hypr/hyprland.conf"
    
    # Comment out all
    for i in "${!shells[@]}"; do
        sed -i "s/^exec-once = ${launch_cmds[$i]}/#exec-once = ${launch_cmds[$i]}/" "$conf"
    done
    
    # Uncomment target
    sed -i "s/#exec-once = ${launch_cmds[$idx]}/exec-once = ${launch_cmds[$idx]}/" "$conf"
    
    hyprctl reload &>/dev/null || true
}

# Show menu
show_menu() {
    local current="$1"
    
    echo ""
    echo "Select a shell to switch to:"
    echo ""
    
    for i in "${!shells[@]}"; do
        if [[ "${shells[$i]}" == "$current" ]]; then
            echo "$((i + 1))) ${GREEN}* ${names[$i]} (active)${NC}"
        else
            echo "$((i + 1))) ${names[$i]}"
        fi
    done
    echo ""
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: shell-switch <ambxst|caelestia|dms|noctalia>"
        echo "Or use Super+Ctrl+1-4 in Hyprland"
        exit 1
    fi
    
    local current
    current=$(detect_shell)
    
    local new_shell="$1"
    local new_idx
    new_idx=$(get_shell_index "$new_shell")
    
    if [[ "$new_idx" == "-1" ]]; then
        error "Unknown shell: $new_shell"
        echo "Available: ${shells[*]}"
        exit 1
    fi
    
    if [[ "$new_shell" == "$current" ]]; then
        log "${names[$new_idx]} is already active"
        exit 0
    fi
    
    echo ""
    log "Switching from ${names[$(get_shell_index "$current")]:-none} to ${names[$new_idx]}..."
    echo ""
    
    if [[ -n "$current" ]]; then
        kill_shell "$(get_shell_index "$current")"
    fi
    
    update_config "$new_idx"
    start_shell "$new_idx"
    
    echo ""
    log "Switched to ${names[$new_idx]}!"
}

main "$@"
